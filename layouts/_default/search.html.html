{{ define "title" }}
  Search &ndash; {{ .Site.Title }}
{{ end }}
{{ define "main" }}
  <div id="search-results">

  </div>
  <template id="search-result-template">
    <p><a href="#"></a></p>
  </template>
  {{/* TODO better way to load lunr script? inline this? */}}
  <script src="/lunr.js" type="text/javascript"></script>
  <script type="text/javascript">
    async function loadIndex() {
      // TODO: handle fetch errors
      return lunr.Index.load(await (await fetch('/lunr-index.json')).json());
    }
    (async () => {
      const idx = await loadIndex();
      // TODO: is DOMContentLoaded needed here
      const resultsElem = document.getElementById('search-results');
      for (let result of idx.search(getSearchString())) {
        const resultElem = createResultElem(result.ref, result.ref);
        resultsElem.appendChild(resultElem);
      }
    })();
    function getSearchString() {
      return new URLSearchParams(location.search).get('q');
    }
    function createResultElem(url, name) {
      const resultElem = document.getElementById('search-result-template').content.cloneNode(true);
      resultElem.querySelector('a').href = url;
      resultElem.querySelector('a').textContent = name;
      return resultElem;
    }
  </script>
{{ end }}
